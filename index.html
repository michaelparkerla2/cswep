<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CSWEP - Crypto Dust Sweeper</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .wallet-btn, .sweep-btn { padding: 10px 20px; margin: 10px; }
    table { margin: 20px auto; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="main-content">
    <button class="wallet-btn" onclick="connectWallet()">Connect Wallet</button>
    <div id="tokenTable">
      <table>
        <thead>
          <tr><th>Token</th><th>Your Balance</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="sweep-btn" onclick="simulateSweep()">Sweep My Crumbs</button>
  </div>

  <script>
    let provider, signer, userAddress;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask is not installed.");
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await provider.getNetwork();
        console.log("Connected to network:", network);
        if (network.chainId !== 1) {
          alert("Please switch to Ethereum Mainnet.");
          return;
        }
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        console.log("Wallet connected:", userAddress);
        await fetchTokenBalances(userAddress);
      } catch (error) {
        console.error("Connection error:", error);
        alert("Failed to connect wallet: " + error.message);
      }
    }

    async function fetchTokenBalances(address) {
      const tokenList = [
        { name: 'ETH', symbol: 'ETH', decimals: 18 },
        { name: 'USDC', symbol: 'USDC', address: '0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', decimals: 6 },
        { name: 'DAI', symbol: 'DAI', address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals: 18 }
      ];

      const erc20Abi = ["function balanceOf(address) view returns (uint256)"];

      try {
        console.log("Fetching ETH balance...");
        const ethBalance = await provider.getBalance(address);
        const ethFormatted = ethers.utils.formatEther(ethBalance);
        console.log("ETH balance:", ethFormatted);
        renderTokenRow('ETH', ethFormatted);

        for (let token of tokenList.slice(1)) {
          console.log(`Fetching balance for ${token.name}...`);
          const contract = new ethers.Contract(token.address, erc20Abi, provider);
          const rawBalance = await contract.balanceOf(address);
          const formattedBalance = ethers.utils.formatUnits(rawBalance, token.decimals);
          console.log(`${token.name} balance:`, formattedBalance);
          renderTokenRow(token.name, formattedBalance);
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("Failed to fetch balances: " + error.message);
      }
    }

    function renderTokenRow(name, balance) {
      const tbody = document.querySelector('#tokenTable tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="checkbox" ${parseFloat(balance) > 0 ? 'checked' : 'disabled'} /> ${name}</td>
        <td>${parseFloat(balance).toFixed(6)}</td>
      `;
      tbody.appendChild(row);
    }

    function simulateSweep() {
      const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
      if (selected.length === 0) {
        alert("No tokens selected to sweep.");
        return;
      }
      alert("Sweep simulation successful!");
    }

    window.onload = () => {
      document.querySelector('#tokenTable tbody').innerHTML = '';
    };
  </script>
</body>
</html>
